<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAHyIOzxwKHiEWwKFYcSvBRSAUkAgo5vWU",
        authDomain: "trickster-21842.firebaseapp.com",
        databaseURL: "https://trickster-21842-default-rtdb.firebaseio.com",
        projectId: "trickster-21842",
        storageBucket: "trickster-21842.firebasestorage.app",
        messagingSenderId: "510076861931",
        appId: "1:510076861931:web:b29ec56d0c518c1da32dae"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    let activeForm = null;

    // عرض النماذج المتاحة
    onValue(ref(db, 'forms'), (snapshot) => {
        const container = document.getElementById('forms-container');
        if(!snapshot.exists()) {
            container.innerHTML = '<p class="text-center text-zinc-600 pt-20">لا توجد تقديمات حالياً</p>';
            return;
        }
        
        let html = "";
        snapshot.forEach(child => {
            const f = child.val();
            f.id = child.key;
            html += `
                <div class="apply-card">
                    <h2 class="text-2xl font-black mb-1">${f.name}</h2>
                    <p class="text-zinc-400 mb-4">${f.description || ''}</p>
                    <button onclick="window.openForm('${f.id}')" class="w-full py-4 rounded-xl font-bold bg-orange-600 hover:bg-orange-700 transition">تقديم الآن</button>
                </div>`;
        });
        container.innerHTML = html;
        window.allForms = snapshot.val(); // حفظ النماذج مؤقتاً
    });

    // فتح النموذج للإرسال
    window.openForm = (id) => {
        activeForm = window.allForms[id];
        document.getElementById('form-title-display').innerText = activeForm.name;
        document.getElementById('questions-list').innerHTML = activeForm.questions.map((q, i) => `
            <div>
                <label class="block text-xs text-zinc-500 mb-2">${q.text}</label>
                <input type="text" name="q_${i}" required class="w-full bg-black border border-zinc-800 p-3 rounded-xl text-white outline-none">
            </div>`).join('');
        document.getElementById('apply-overlay').classList.remove('hidden');
    };

    // إرسال الطلب للـ Admin
    document.getElementById('application-form').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            formName: activeForm.name,
            roblox: document.getElementById('roblox_name').value,
            discord: document.getElementById('discord_name').value,
            submittedAt: Date.now()
        };

        await set(push(ref(db, 'submissions')), data);
        alert('تم إرسال طلبك بنجاح!');
        location.reload();
    };
</script>
